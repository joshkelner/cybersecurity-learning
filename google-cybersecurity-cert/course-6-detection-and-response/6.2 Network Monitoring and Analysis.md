## Network Traffic
(Refer to earlier notes on networking)
* We can compare network activity to normal expectations to detect **indicators of compromise (IoC)**
    * Evidence that suggests a security incident
* Have good baseline
* **Flow Analysis**
    * Flow is movement of network communications
    * Info related to packets, protocols, and ports
    * Many ports are associated with certain protocols
    * Attackers may use ports and protocols that aren't commonly associated
* **Packet payload information**
    * Monitor information on packets (source and destination IP, body data) for irregularities
* **Temporal patterns**
    * Packets contain timestamps
    * Monitor if many are coming at unusual times
* **Data Exfiltration Attack**
    * First attackers need to get into system (maybe through phishing)
    * Perform lateral movement: explore network and expand reach
    * Scope out valuable assets and collect sensitive data
    * Then they prepare data for exfiltration - might reduce data size to bypass controls
    * Exfiltrate data to themselves
## Capture Network Traffic
(See earlier notes)
* Packet sniffers can caputre and view packets traveling across a network
* **Packet capture** - File containing intercepted packets
    * Different types for different network protocal analyzers (ex npcap for nmap)
    * Network analyzers let you filter packet captures
* Netwrok analyzers: tcpdump (CLI), Wireshark (GUI)
### IP Headers
* IPv4 and IPv6 have different headers (but similar fields)
* For IPv4:
    * **Version**
        * Which version is used
    * **Internet Header Length (IHL)**
        * Length of header
    * **Type of Service (ToS)**
        * If cetain packets should be treated differently
    * **Total Length**
        * Length of whole packet (header+data)
    * **Identification, Flags, Fragment Offset**
        * Deal with fragmentation (breaking up packets)
        * If it's been fragmented and how to reassamble
    * **Time to Live (TTL)**
        * How long until it gets dropped (otherwise could loop endlessly through router)
    * **Protocol**
        * Value corresponding to protocol used
    * **Header Checksum**
        * Stores checksum (determines if errors occured in header)
    * **Source Address**
    * **Destination Address**
    * **Options**
        * Not necessary, used for troubleshooting
* For IPv6:
    * **Version**
    * **Traffic Class**
        * Like Type of Service
    * **Flow Label**
        * Identifies packets of a flow (sequence from specific source)
    * **Payload Length**
        * Length of just data portion
    * **Next Header**
        * Like Protocol
    * **Hop Limit**
        * Like Time to Live
    * **Source Address**
    * **Destination Address**
### Wireshark
* Open-source GUI network protocal analyzer
* **Display filters** - apply filters to packet capture files
* Comparison operators (either symbol or abbrev)
    * ==, !=, >, <, >=, <=
    * eq, ne, gt, lt, ge, le
    * and, or
* contains
    * Filter for exact match
* matches
    * Filter based on regex pattern
* Protocal filtering
    * One of the simplest ways
    * Just type protocol name in toolbar
* IP filtering
    * ip.addr == xxxxxxxx (either)
    * ip.src == xxxxxxx   (source)
    * ip.dst == xxxxxx  (destination)
* MAC address filtering
    * eth.addr = xxxxxx
* Port filtering
    * tcp.port == xx
    * udp.port == xx
* Follow streams
    * Filters by protocol and you can view the exchange of data on that protocol
### tcpdump
* Pre-installed on many Linux distros, installable on most Unix-like OS
* CLI tool, lightweight
* Use options and flags on commands
* **sudo tcpdump** - to use it
    * -i : which interface to sniff traffic (required)
    * **Options** 
        * -v : verbose, gives detailed info (-vv, -vvv)
        * -c __ : count, how many packets
        * -w file.pcap : write sniffed packets to a p-cap file
        * -r file.pcap: read a pcap file
        * -n : disables name resolution, by default it converts IPs to names and ports to commonly used services. Not always accurate and uses reverse DNS lookup for IPs so attacker could see you are investigating them
        * -nn : disables port and protocol name lookup
        * -X : displays hex and ASCII packet data
        * -D : checks available interfaces (so does ifconfig on Linux)
    * **Filter Expressions**
        * Use logic to filter
        * By protocol, port, etc
* Output:
    * Timestamp
    * Version
        * Verbose gives extra info about IP fields
    * Addresses (port included at the end of address)
    * Header checksum

